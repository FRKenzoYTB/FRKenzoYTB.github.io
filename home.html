<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>InterPay </title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background: #f7f9fc;
      min-height: 100vh;
    }

    /* ---- HEADER ---- */
    .topbar {
      background: #003087;
      padding: 15px 30px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .user-info img {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: 2px solid #fff;
    }
    .user-details {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }
    .user-details strong { font-size: 15px; }
    .user-details small { color: #ddd; font-size: 13px; }
    .logout {
      background: #c0392b;
      border: none;
      padding: 8px 15px;
      border-radius: 20px;
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 5px;
    }
    .logout:hover { background: #e74c3c; }

    /* ---- CONTAINER ---- */
    .container {
      max-width: 1100px;
      margin: 40px auto;
      padding: 0 20px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
    }

    /* ---- CARD ---- */
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      margin-bottom: 20px;
    }
    .balance {
      font-size: 32px;
      font-weight: 700;
      color: #003087;
      margin-bottom: 15px;
    }

    /* ---- BUTTONS ---- */
    .btn {
      background: #0070ba;
      color: #fff;
      padding: 12px 22px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .btn:hover { background: #00457c; }

    /* ---- ACTIONS ---- */
    .actions {
      display: flex;
      justify-content: space-between;
      gap: 15px;
    }
    .action {
      flex: 1;
      background: #f0f7ff;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: 0.2s;
    }
    .action:hover { background: #e3f0ff; }
    .action h4 {
      margin-top: 10px;
      font-size: 16px;
      font-weight: 600;
      color: #003087;
    }

    /* ---- NOTIFICATIONS ---- */
    .logs { max-height: 400px; overflow-y: auto; }
    .log {
      display: flex;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .log:last-child { border: none; }
    .log span { font-size: 15px; color: #444; }

    /* ---- MODAL ---- */
    .modal {
      display: none;
      position: fixed;
      z-index: 50;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      width: 350px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    .modal-content h3 {
      margin-bottom: 15px;
      font-size: 18px;
      font-weight: 600;
      color: #003087;
    }
    .modal-content input, .modal-content textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }
    .close {
      float: right;
      cursor: pointer;
      font-size: 20px;
      color: #888;
    }
    .close:hover { color: #333; }
    #claimAction {
  background: #ffcc00;
  animation: pulse 1s infinite alternate;
}
@keyframes pulse {
  from { background: #ffcc00; }
  to   { background: #ff8800; }
}

  </style>
</head>
<body>
  <!-- HEADER -->
<div class="topbar">
  <div>
    <img src="logo.png" alt="InterPay" style="height:40px;">
  </div>
  <div class="user-info">
    <img id="userPfp" src="https://via.placeholder.com/45" alt="PFP">
    <div class="user-details">
      <strong id="userPseudo">Chargement...</strong>
      <small id="userEmail"></small>
      <button class="logout" id="logoutBtn">Déconnexion</button>
    </div>
  </div>
</div>


  <!-- MAIN -->
  <div class="container">
    <!-- LEFT SIDE -->
    <div>
      <div class="card">
        <div class="balance">Solde : <span id="balance">0</span> µ</div>
      </div>

      <div class="card">
        <h3>Actions</h3>
        <div class="actions">
          <div class="action" id="envoyerAction"><h4>Envoyer</h4></div>
          <div class="action" id="demanderAction"><h4>Demander</h4></div>
          <div class="action" id="claimAction"><h4 id="claimText">Réclamer</h4></div>
        </div>
      </div>

      <div class="card">
        <h3>Notifications</h3>
        <div class="logs" id="logs"></div>
      </div>
    </div>

    <!-- RIGHT SIDE -->
    <div>
      <div class="card">
        <h3>Paramètres</h3>
        <button class="btn" id="settingsBtn">Modifier mes infos</button>
      </div>
    </div>
  </div>

  <!-- MODALS -->
  <!-- Envoyer -->
  <div class="modal" id="donateModal">
    <div class="modal-content">
      <span class="close" id="closeDonate">&times;</span>
      <h3>Envoyer de l'argent</h3>
      <input type="email" id="destEmail" placeholder="Email du destinataire" required>
      <input type="number" id="amount" placeholder="Montant (µ)" min="1" required>
      <textarea id="message" placeholder="Message (optionnel)"></textarea>
      <button class="btn" id="sendMoney">Envoyer</button>
    </div>
  </div>

  <!-- Demander -->
  <div class="modal" id="requestModal">
    <div class="modal-content">
      <span class="close" id="closeRequest">&times;</span>
      <h3>Votre email</h3>
      <input type="text" id="copyEmail" readonly>
      <button class="btn" id="copyBtn">Copier</button>
    </div>
  </div>

  <!-- Paramètres -->
<!-- Paramètres -->
<div class="modal" id="settingsModal">
  <div class="modal-content">
    <span class="close" id="closeSettings">&times;</span>
    <h3>Modifier mes infos</h3>
    <input type="text" id="newPseudo" placeholder="Nouveau pseudo">
    <input type="url" id="newPfp" placeholder="URL photo de profil">
    <input type="password" id="discordKey" placeholder="Clé Discord (5 caractères)">
    <button class="btn" id="saveSettings">Sauvegarder</button>
  </div>
</div>



<script>
const firebaseConfig = {
  apiKey: "AIzaSyDyWu4TI4PIRXfeb7yqt0WIGClgu10IjkM",
  authDomain: "kylita-f2923.firebaseapp.com",
  databaseURL: "https://kylita-f2923-default-rtdb.firebaseio.com",
  projectId: "kylita-f2923",
  storageBucket: "kylita-f2923.appspot.com",
  messagingSenderId: "431823530994",
  appId: "1:431823530994:web:88a07e633751686e5ad96b",
  measurementId: "G-F4LLNWQJ16"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentUser = null, currentUid = null, balance = 0;

auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "index.html"; 
    return;
  }

  currentUser = user;
  currentUid = user.uid;

  // Récup infos utilisateur
  db.ref("users/" + currentUid).once("value").then(snapshot => {
    const data = snapshot.val();
    if (!data) {
      alert("Erreur : profil utilisateur introuvable. Veuillez compléter votre profil.");
      auth.signOut();
      return;
    }
    updateUserUI(data);
  });

  // Solde en temps réel
  db.ref("users/" + currentUid + "/balance").on("value", snap => {
    balance = snap.val() || 0;
    document.getElementById("balance").textContent = balance;
  });

  // Logs en temps réel
  db.ref("users/" + currentUid + "/logs").on("child_added", snap => {
    displayLog(snap.val());
  });

  // --- Gestion du bouton Réclamer ---
  const claimBtn = document.getElementById("claimAction");
  const claimText = document.getElementById("claimText");

  db.ref("users/" + currentUid + "/claim").on("value", snap => {
    const claimStatus = snap.val();

    if (claimStatus === true) {
      // Déjà réclamé → bouton grisé et message clair
      claimBtn.style.display = "block";
      claimBtn.style.opacity = "0.5";
      claimBtn.disabled = true;
      claimText.textContent = "Vous avez déjà réclamé.";
      claimBtn.onclick = null;
    } else if (claimStatus === "pending") {
      claimBtn.style.display = "block";
      claimBtn.style.opacity = "0.5";
      claimBtn.disabled = true;
      claimText.textContent = "En attente...";
      claimBtn.onclick = null;
    } else {
      // false ou inexistant → bouton utilisable
      claimBtn.style.display = "block";
      claimBtn.style.opacity = "1";
      claimBtn.disabled = false;
      claimText.textContent = "Réclamer";
      claimBtn.onclick = () => {
        db.ref("users/" + currentUid + "/claim").set("pending");
      };
    }
  });


// --- Fonctions utilitaires ---
function updateUserUI(data) {
  document.getElementById("userPseudo").textContent = data.username || "NON DEFINI";
  document.getElementById("userEmail").textContent = data.email || currentUser.email;
  document.getElementById("userPfp").src = data.pfp || "https://via.placeholder.com/45";
  document.getElementById("copyEmail").value = data.email || currentUser.email;
}

function displayLog(msg) {
  const logsDiv = document.getElementById("logs");
  const div = document.createElement("div");
  div.className = "log";
  div.innerHTML = `<span>${msg}</span>`;
  logsDiv.prepend(div);
}

// --- Actions rapides ---
document.getElementById("envoyerAction").onclick = () => {
  document.getElementById("donateModal").style.display = "flex";
};
document.getElementById("demanderAction").onclick = () => {
  document.getElementById("requestModal").style.display = "flex";
};

// --- Fermeture modals ---
document.getElementById("closeDonate").onclick = () => {
  document.getElementById("donateModal").style.display = "none";
};
document.getElementById("closeRequest").onclick = () => {
  document.getElementById("requestModal").style.display = "none";
};
document.getElementById("closeSettings").onclick = () => {
  document.getElementById("settingsModal").style.display = "none";
};

// --- Copier email ---
document.getElementById("copyBtn").onclick = () => {
  navigator.clipboard.writeText(document.getElementById("copyEmail").value);
  alert("Email copié !");
};

// --- Envoyer de l'argent ---
document.getElementById("sendMoney").onclick = async () => {
  const destEmail = document.getElementById("destEmail").value.trim();
  const amount = parseInt(document.getElementById("amount").value);
  if (!destEmail || !amount) return alert("Champs obligatoires !");
  if (amount > balance) return alert("Montant supérieur à votre solde.");

  const usersSnap = await db.ref("users").once("value");
  let destUid = null;
  usersSnap.forEach(child => {
    if (child.val().email === destEmail) destUid = child.key;
  });

  if (!destUid) return alert("Destinataire introuvable.");

  db.ref("users/" + currentUid + "/balance").set(balance - amount);
  db.ref("users/" + currentUid + "/logs").push(`Vous avez envoyé ${amount}µ à ${destEmail}`);
  db.ref("users/" + destUid + "/balance").transaction(b => (b || 0) + amount);
  db.ref("users/" + destUid + "/logs").push(`Vous avez reçu ${amount}µ de ${currentUser.email}`);

  document.getElementById("donateModal").style.display = "none";
};

// --- Déconnexion ---
document.getElementById("logoutBtn").onclick = () => auth.signOut();

// --- Paramètres ---
document.getElementById("settingsBtn").onclick = () => {
  document.getElementById("settingsModal").style.display = "flex";
};
document.getElementById("saveSettings").onclick = async () => {
  const newPseudo = document.getElementById("newPseudo").value.trim();
  const newPfp = document.getElementById("newPfp").value.trim();
  const discordKey = document.getElementById("discordKey").value.trim().toUpperCase();

  let updates = {};
  if (newPseudo) updates.username = newPseudo;
  if (newPfp) updates.pfp = newPfp;

  if (discordKey) {
    const usersSnap = await db.ref("discord_users").once("value");
    let matchedUser = null;
    usersSnap.forEach(child => {
      if (child.val().link_key === discordKey) {
        matchedUser = { uid: child.key, data: child.val() };
      }
    });

    if (!matchedUser) {
      return alert("Clé Discord invalide.");
    }

    balance = matchedUser.data.balance || 0;
    document.getElementById("balance").textContent = balance;

    updates.discord_key = discordKey;
  }

  if (Object.keys(updates).length > 0) {
    db.ref("users/" + currentUid).update(updates);
  }

  document.getElementById("settingsModal").style.display = "none";
  alert("Paramètres mis à jour !");
};


</script>


</body>
</html>

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat</title>
  <style>
:root {
    --bg: #0f1724;
    --card: #0b1220;
    --accent: #60a5fa;
    --muted: #9aa4b2;
    --bubble: #0b1a2b;
}

html, body {
    height: 100%;
    margin: 0;
    font-family: Inter, system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg, #071022 0%, #08172a 100%);
    display: flex;
    flex-direction: column;
    color: #e6eef6;
}

/* Conteneur plein écran */
.container {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
}

/* Zone principale : messages + input */
main {
    display: flex;
    flex-direction: column;
    flex: 1;
}

/* Liste des messages */
#messages {
    flex: 1;
    padding: 18px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: transparent;
}

/* Bulles messages */
.msg {
    max-width: 78%;
    padding: 10px 12px;
    border-radius: 10px;
    background: var(--bubble);
    box-shadow: inset 0 -1px 0 rgba(255,255,255,0.02);
}
.meta {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 6px;
}
.mine {
    align-self: flex-end;
    background: linear-gradient(180deg, rgba(96,165,250,0.15), rgba(96,165,250,0.06));
    border: 1px solid rgba(96,165,250,0.1);
}

/* Barre de contrôle */
.controls {
    display: flex;
    gap: 8px;
    padding: 12px;
    position: relative;
    background: transparent;
}

/* Effet glassmorphism + bulles */
.controls::before {
    content: "";
    position: absolute;
    inset: 0;
    backdrop-filter: blur(12px);
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    z-index: 0;
}

/* Animation bulles */
.controls::after {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.05) 5%, transparent 20%),
                radial-gradient(circle at 80% 40%, rgba(255,255,255,0.05) 5%, transparent 20%),
                radial-gradient(circle at 40% 80%, rgba(255,255,255,0.05) 5%, transparent 20%);
    animation: bubbleMove 10s infinite linear;
    z-index: 0;
}

@keyframes bubbleMove {
    0% { background-position: 0 0, 0 0, 0 0; }
    100% { background-position: 100px 200px, -150px 100px, 200px -150px; }
}

/* Champ texte */
.controls input[type=text] {
    flex: 1;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.08);
    backdrop-filter: blur(8px);
    color: inherit;
    font-size: 14px;
    z-index: 1;
}

/* Bouton envoyer avec image */
.controls button {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    border: none;
    background: url("send.png") center/20px no-repeat var(--accent);
    cursor: pointer;
    z-index: 1;
}
.msg {
  max-width: 60%;
  margin: 5px 0;
  padding: 8px 12px;
  background: #2776F5;
  border-radius: 8px;
  clear: both;
}

.msg.mine {
  background: #35F527;
  color: white;
  margin-left: auto;  /* pousse à droite */
  text-align: right;
}

  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Chat</h1>
      <div class="user">Connecté en tant que <strong id="usernameDisplay">...</strong></div>
    </header>

    <main>
      <div id="messages">
        <div class="empty">Chargement des messages…</div>
      </div>

      <div class="controls">
        <input id="messageInput" type="text" placeholder="Écris un message..." autocomplete="off" />
        <button id="sendBtn">Envoyer</button>
      </div>
    </main>
  </div>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAzSzAc3Fz18PdgumpGY3_s2K42v2MzYK0",
  authDomain: "message-957c6.firebaseapp.com",
  databaseURL: "https://message-957c6-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "message-957c6",
  storageBucket: "message-957c6.firebasestorage.app",
  messagingSenderId: "518720941529",
  appId: "1:518720941529:web:7c6b444ef9ac0b0d127dc8",
  measurementId: "G-GW0GKGQ9EP"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let username = null;
const usernameDisplay = document.getElementById("usernameDisplay");
const messagesEl = document.getElementById("messages");
const input = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");

auth.onAuthStateChanged(user => {
  if (user) {
    const uid = user.uid;
    db.ref("users/" + uid + "/displayName").once("value").then(snap => {
      username = snap.val() || "Invité";
      usernameDisplay.textContent = username;
    });
  } else {
    window.location.href = "index.html";
  }
});

function sendMessage() {
  const text = input.value.trim();
  if (!text || !username) return;
  
  db.ref("messages").push({
    name: username,
    text: text,
    timestamp: Date.now()
  });
  
  input.value = "";
  input.focus();
}

sendBtn.addEventListener("click", sendMessage);
input.addEventListener("keydown", e => {
  if (e.key === "Enter") sendMessage();
});

function escapeHtml(str) {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function renderMessage(obj) {
  const div = document.createElement("div");
  div.className = "msg" + (obj.name === username ? " mine" : "");
  
  const meta = document.createElement("div");
  meta.className = "meta";
  meta.innerHTML = `${escapeHtml(obj.name)} · <span>${new Date(obj.timestamp).toLocaleTimeString()}</span>`;
  
  const body = document.createElement("div");
  body.innerHTML = escapeHtml(obj.text);
  
  div.appendChild(meta);
  div.appendChild(body);
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// Messages système (connexion/déconnexion)
function renderSystemMessage(text, color) {
  const div = document.createElement("div");
  div.className = "msg system";
  div.style.color = color;
  div.style.textAlign = "center";
  div.style.margin = "8px 0";
  div.style.fontStyle = "italic";
  div.textContent = text;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// Écoute de l'état de connexion Firebase
let wasConnected = true;
db.ref(".info/connected").on("value", snap => {
  if (snap.val() === true) {
    if (!wasConnected) {
      renderSystemMessage("Reconnecté.", "#aaa");
    }
    wasConnected = true;
  } else {
    if (wasConnected) {
      renderSystemMessage("Déconnecté. Reconnexion...", "red");
    }
    wasConnected = false;
  }
});

// Affichage des messages
db.ref("messages").orderByChild("timestamp").limitToLast(200).on("child_added", snap => {
  const data = snap.val();
  if (data) renderMessage(data);
});
</script>

</body>
</html>

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat</title>
  <style>
:root {
    --bg: #0f1724;
    --card: #0b1220;
    --accent: #60a5fa;
    --muted: #9aa4b2;
    --bubble: #0b1a2b;
}

html, body {
    height: 100%;
    margin: 0;
    font-family: Inter, system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg, #071022 0%, #08172a 100%);
    display: flex;
    flex-direction: column;
    color: #e6eef6;
}

/* Conteneur plein écran */
.container {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
}

/* Zone principale : messages + input */
main {
    display: flex;
    flex-direction: column;
    flex: 1;
}

/* Liste des messages */
#messages {
    flex: 1;
    padding: 18px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: transparent;
}

/* Bulles messages */
.msg {
    max-width: 78%;
    padding: 10px 12px;
    border-radius: 10px;
    background: var(--bubble);
    box-shadow: inset 0 -1px 0 rgba(255,255,255,0.02);
}
.meta {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 6px;
}
.mine {
    align-self: flex-end;
    background: linear-gradient(180deg, rgba(96,165,250,0.15), rgba(96,165,250,0.06));
    border: 1px solid rgba(96,165,250,0.1);
}

/* Barre de contrôle */
.controls {
    display: flex;
    gap: 8px;
    padding: 12px;
    position: relative;
    background: transparent;
}

/* Effet glassmorphism + bulles */
.controls::before {
    content: "";
    position: absolute;
    inset: 0;
    backdrop-filter: blur(12px);
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    z-index: 0;
}

/* Animation bulles */
.controls::after {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.05) 5%, transparent 20%),
                radial-gradient(circle at 80% 40%, rgba(255,255,255,0.05) 5%, transparent 20%),
                radial-gradient(circle at 40% 80%, rgba(255,255,255,0.05) 5%, transparent 20%);
    animation: bubbleMove 10s infinite linear;
    z-index: 0;
}

@keyframes bubbleMove {
    0% { background-position: 0 0, 0 0, 0 0; }
    100% { background-position: 100px 200px, -150px 100px, 200px -150px; }
}

/* Champ texte */
.controls input[type=text] {
    flex: 1;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.08);
    backdrop-filter: blur(8px);
    color: inherit;
    font-size: 14px;
    z-index: 1;
}

/* Bouton envoyer avec image */
.controls button {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    border: none;
    background: url("send.png") center/20px no-repeat var(--accent);
    cursor: pointer;
    z-index: 1;
}
.msg {
  max-width: 60%;
  margin: 5px 0;
  padding: 8px 12px;
  background: #2776F5;
  border-radius: 8px;
  clear: both;
}

.msg.mine {
  background: #35F527;
  color: white;
  margin-left: auto;  /* pousse à droite */
  text-align: right;
}

  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Chat</h1>
      <div class="user">Connecté en tant que <strong id="usernameDisplay">...</strong></div>
    </header>

    <main>
      <div id="messages">
        <div class="empty">Chargement des messages…</div>
      </div>

      <div class="controls">
        <input id="messageInput" type="text" placeholder="Écris un message..." autocomplete="off" />
        <button id="sendBtn">Envoyer</button>
      </div>
    </main>
  </div>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
// Initialisation Firebase (remplace par ta config)
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDyWu4TI4PIRXfeb7yqt0WIGClgu10IjkM",
  authDomain: "kylita-f2923.firebaseapp.com",
  databaseURL: "https://kylita-f2923-default-rtdb.firebaseio.com",
  projectId: "kylita-f2923",
  storageBucket: "kylita-f2923.firebasestorage.app",
  messagingSenderId: "431823530994",
  appId: "1:431823530994:web:88a07e633751686e5ad96b",
  measurementId: "G-F4LLNWQJ16"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const messagesEl = document.getElementById("messages");
const form = document.getElementById("form");
const input = document.getElementById("input");

let username = localStorage.getItem("username");

// Si pas de pseudo, demander à l’utilisateur
if (!username) {
  username = prompt("Entrez votre pseudo");
  localStorage.setItem("username", username);
}

const messagesRef = db.ref("messages");

// Fonction pour afficher un message dans le chat
function renderMessage(obj) {
  const div = document.createElement("div");
  div.className = "msg" + (obj.name === username ? " mine" : "");
  
  // Si c’est un message système (erreur/reconnexion)
  if (obj.system) {
    div.className = "msg system";
    div.textContent = obj.text;
  } else {
    div.innerHTML = `<span class="author">${obj.name}</span> : ${obj.text}`;
  }

  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// Charger les messages en temps réel
messagesRef.orderByChild("timestamp").limitToLast(100).on("value", snapshot => {
  messagesEl.innerHTML = "";
  snapshot.forEach(child => {
    renderMessage(child.val());
  });
});

// Envoyer un message
form.addEventListener("submit", e => {
  e.preventDefault();
  if (input.value.trim() === "") return;

  const msgObj = {
    name: username,
    text: input.value.trim(),
    timestamp: Date.now(),
    system: false
  };

  messagesRef.push(msgObj);
  input.value = "";
});

// Gestion des statuts de connexion
function sendSystemMessage(text, isError = false) {
  const msgObj = {
    name: "",
    text: text,
    timestamp: Date.now(),
    system: true,
    error: isError
  };
  messagesRef.push(msgObj);
}

// Ecoute de l'état de connexion Firebase
firebase.database().ref(".info/connected").on("value", snap => {
  if (snap.val() === true) {
    sendSystemMessage("Reconnecté.");
  } else {
    sendSystemMessage("Déconnecté. Reconnexion...", true);
  }
});

</script>

</body>
</html>

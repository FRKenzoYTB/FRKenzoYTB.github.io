<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Titicraft - Connexion / Inscription</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 400px; margin: 30px auto; padding: 10px; }
    #home, #logoutBtn { display: none; }
    form { margin-bottom: 20px; }
    input { display: block; margin: 10px 0; padding: 8px; width: 100%; }
    button { padding: 10px; width: 100%; cursor: pointer; }
    #message { color: red; }
  </style>
</head>
<body>

  <h1>Titicraft</h1>

  <!-- Zone messages d'erreur ou succès -->
  <div id="message"></div>

  <!-- Formulaire inscription -->
  <form id="registerForm">
    <h2>Créer un compte</h2>
    <input type="email" id="regEmail" placeholder="Email" required />
    <input type="password" id="regPassword" placeholder="Mot de passe" required />
    <input type="text" id="regPseudo" placeholder="Pseudo" required />
    <button type="submit">S'inscrire</button>
  </form>

  <!-- Formulaire connexion -->
  <form id="loginForm">
    <h2>Se connecter</h2>
    <input type="email" id="logEmail" placeholder="Email" required />
    <input type="password" id="logPassword" placeholder="Mot de passe" required />
    <button type="submit">Se connecter</button>
  </form>

  <!-- Page d'accueil après connexion -->
  <div id="home">
    <h2>Bienvenue, <span id="userPseudo"></span> !</h2>
    <p>Diamants : <span id="userDiamonds">0</span></p>
    <button id="logoutBtn">Déconnexion</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

    // TA CONFIG FIREBASE ICI
    const firebaseConfig = {
      apiKey: "TA_CLE_API",
      authDomain: "TON_PROJET.firebaseapp.com",
      databaseURL: "https://TON_PROJET-default-rtdb.REGION.firebasedatabase.app",
      projectId: "TON_PROJET",
      storageBucket: "TON_PROJET.appspot.com",
      messagingSenderId: "TON_ID",
      appId: "TON_APP_ID",
      measurementId: "TON_MEASUREMENT_ID"
    };

    // Initialisation Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Elements DOM
    const registerForm = document.getElementById('registerForm');
    const loginForm = document.getElementById('loginForm');
    const homeDiv = document.getElementById('home');
    const messageDiv = document.getElementById('message');
    const userPseudoSpan = document.getElementById('userPseudo');
    const userDiamondsSpan = document.getElementById('userDiamonds');
    const logoutBtn = document.getElementById('logoutBtn');

    // Fonction afficher message
    function showMessage(text, isError = true) {
      messageDiv.textContent = text;
      messageDiv.style.color = isError ? "red" : "green";
      setTimeout(() => messageDiv.textContent = '', 5000);
    }

    // Création compte
    registerForm.addEventListener('submit', e => {
      e.preventDefault();
      const email = document.getElementById('regEmail').value;
      const password = document.getElementById('regPassword').value;
      const pseudo = document.getElementById('regPseudo').value;

      createUserWithEmailAndPassword(auth, email, password)
        .then(userCredential => {
          const user = userCredential.user;
          // Stocker profil dans DB
          return set(ref(db, 'users/' + user.uid), {
            pseudo: pseudo,
            email: email,
            diamonds: 0,
            id: user.uid
          });
        })
        .then(() => {
          showMessage('Compte créé ! Connecte-toi maintenant.', false);
          registerForm.reset();
        })
        .catch(error => {
          showMessage(error.message);
        });
    });

    // Connexion
    loginForm.addEventListener('submit', e => {
      e.preventDefault();
      const email = document.getElementById('logEmail').value;
      const password = document.getElementById('logPassword').value;

      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          loginForm.reset();
          showMessage('Connecté !', false);
        })
        .catch(error => {
          showMessage(error.message);
        });
    });

    // Déconnexion
    logoutBtn.addEventListener('click', () => {
      signOut(auth);
    });

    // Surveille l’état de connexion
    onAuthStateChanged(auth, user => {
      if (user) {
        // Afficher home, masquer forms
        registerForm.style.display = 'none';
        loginForm.style.display = 'none';
        homeDiv.style.display = 'block';
        logoutBtn.style.display = 'block';

        // Récupérer données utilisateur et afficher
        get(ref(db, 'users/' + user.uid)).then(snapshot => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            userPseudoSpan.textContent = data.pseudo || 'Anonyme';
            userDiamondsSpan.textContent = data.diamonds ?? 0;
          } else {
            userPseudoSpan.textContent = 'Anonyme';
            userDiamondsSpan.textContent = 0;
          }
        });

      } else {
        // Pas connecté => montrer formulaire, cacher home
        registerForm.style.display = 'block';
        loginForm.style.display = 'block';
        homeDiv.style.display = 'none';
        logoutBtn.style.display = 'none';
        userPseudoSpan.textContent = '';
        userDiamondsSpan.textContent = 0;
      }
    });
  </script>
</body>
</html>

